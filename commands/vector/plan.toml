# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

description = "ðŸ—ºï¸ PLAN: Strategy Phase. Develop a rigorous implementation roadmap."
prompt = """
You are entering the **STRATEGY (Plan)** phase.

**User Objective:** "{{args}}"
*(If empty or "Review Backlog", perform a Backlog Review.)*

**Goal:** Create a specific, atomic, and verified implementation plan.

**Interaction Standards:**
1.  **Explicit Understanding:**
    *   Start by explaining your understanding of the user's request.
    *   State *how* you intend to proceed (the approach).
    *   Acknowledge the command and wait for implicit confirmation (by presenting the plan checklist).
2.  **Rich Plan Structure:**
    *   The generated plan MUST be a comprehensive Design Document, not just a checklist.
    *   Include Analysis (Why), Design (How), and Roadmap (What).
3.  **Backlog Integration:**
    *   If items are selected from `.gemini/BACKLOG.md`, move them to `.gemini/PLAN.md` and remove them from the Backlog.
4.  **Evidence Discipline:**
    *   Collect official references for each major planning decision.

**Protocol:**
1.  **Context Review:**
    *   Read `.gemini/CONTEXT.md` (Constraints), `.gemini/PLAN.md` (Current Plan), `.gemini/STATE.md` (Investigation Findings), and `.gemini/BACKLOG.md` (Icebox, if it exists).
    *   **CRITICAL:** NEVER use `run_shell_command` to execute `/vector:*` commands. These are for the USER to type.
2.  **Plan Archival (Before Overwriting):**
    *   **IF** `.gemini/PLAN.md` contains a non-empty plan (has an Objective and Roadmap):
        *   **Archive:** Append the current content of `.gemini/PLAN.md` to `.gemini/PLAN_ARCHIVE.md` (create if missing) with a timestamp header.
    *   **ELSE:** Skip archival.
3.  **Strategic Analysis:**
    *   **First Principles:** Deconstruct the User Objective.
    *   **Trade-off Analysis:** Briefly evaluate approaches.
    *   **Risk Assessment:** Identify potential failure modes.
4.  **External Evidence Pass (Mandatory):**
    *   Before finalizing design decisions, gather official API docs/samples/specs for each major design choice.
    *   Cite those sources directly in the design rationale.
    *   Record rejected alternatives with source-backed reasoning.
    *   Build an Evidence Table with columns: **Topic | Source | Why authoritative | Last-checked**.
    *   If evidence is stale, conflicting, or incomplete, **STOP** and request user direction.
5.  **Plan Generation:**
    *   **Draft** a step-by-step plan. Each step must be Atomic and Verifiable.
    *   **WRITE** this plan to `.gemini/PLAN.md` using the **Rich Plan Template**.
    *   **Format:**
        *   **1. Objective:** [Clear Goal]
        *   **2. Strategic Analysis:** [First Principles, Trade-offs, Risks]
        *   **3. Design Specification:** [Technical Details, Data Structures, Function Signatures, Official API/Sample Citations]
        *   **4. Alternatives Considered:** [Accepted + Rejected options with source-backed reasoning]
        *   **5. Implementation Roadmap:** [Numbered List of Atomic Steps]
        *   **6. Review:** [Instructions for User Feedback]
6.  **Backlog Management:**
    *   **IF** items were promoted: **WRITE** (Update) `.gemini/BACKLOG.md` to remove them.
7.  **State Update:**
    *   Update `**Phase:**` in `.gemini/STATE.md` to `[STRATEGY]`.
    *   **Constraint:** **DO NOT** overwrite the `## 3. Scratchpad`. Only update the Phase line.

**Output:**
*   **Analysis Summary:** Why this approach was chosen.
*   **Evidence Table:** Include columns **Topic | Source | Why authoritative | Last-checked**.
*   **Plan Checklist:** Present the plan as a checklist (`- [ ] Step...`) and ask for approval.
*   **Prompt:** "Plan established. Please review `.gemini/PLAN.md`. Ready to Execute?"
*   **Navigation:** Append: `> Recommended Action: /vector:work <first_step>`
*   **Stopping Criteria:** DO NOT execute the plan. DO NOT write code. If evidence is stale/conflicting/incomplete, **HALT** and request user direction. Otherwise, **STOP** and **WAIT** for user approval. **DO NOT** execute the recommended command.
"""
