# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

description = "ðŸ” SCAN: Perception Phase. Audit state and detect drift (auto-bootstrap aware)."

prompt = """
You are entering the **PERCEPTION (Scan)** phase.

**User Focus:** "{{args}}"
*(If empty, perform a general environment analysis.)*

**Goal:** Rigorously map the relevant codebase context and **Reconcile** the 4-File System State.

**Interaction Standards:**
1.  **Acknowledge & Rephrase:** Briefly state what you are scanning and why.
2.  **Checklist:** Present findings as a structured list.
3.  **Drift Detection:** Explicitly flag discrepancies between `PLAN.md`, `STATE.md`, and Reality.

**Protocol:**
0.  **Auto-Bootstrap Guardrail:**
    *   If protocol files are missing, create ONLY missing `.gemini/CONTEXT.md`, `.gemini/PLAN.md`, `.gemini/STATE.md`, and `.gemini/BACKLOG.md` with minimal templates before continuing.
    *   This makes scan safe as a first command in a fresh repo.
    *   **CRITICAL:** NEVER use `run_shell_command` to execute `/vector:*` commands. These are for the USER to type.
1.  **State Audit (The 4-File Check):**
    *   **Read ALL** protocol files: `.gemini/CONTEXT.md`, `.gemini/PLAN.md`, `.gemini/STATE.md`, and `.gemini/BACKLOG.md` (if it exists).
2.  **Investigation:**
    *   **Search:** Use `glob`, `list_directory`, or `search_file_content` to locate files relevant to the **User Focus**.
    *   **Verify:** Read key files (`read_file`) to confirm their actual content. Do not rely on file names alone.
3.  **State Update:**
    *   **Write** your raw findings to `.gemini/STATE.md` under the `## 3. Scratchpad` section.
    *   **Constraint:** **PRESERVE** any existing session history. Append new findings.
    *   **Update** the `**Phase:**` in `.gemini/STATE.md` to `[PERCEPTION]`.

**Output:**
*   **Structured Checklist:** List files found and insights as `- [x] Found ...`.
*   **Drift Report:** "Plan says X, but Codebase shows Y."
*   **Prompt:** "Analysis complete. Ready to proceed to Planning?"
*   **Navigation:** Append:
    *   **IF** New Plan needed: `> Recommended Action: /vector:plan <objective>`
    *   **IF** Ideas found for later: `> Recommended Action: /vector:improve`
*   **Stopping Criteria:** DO NOT generate a plan. DO NOT modify code. **STOP** and **WAIT** for the user to select the next action. **DO NOT** execute the recommended command.
"""
