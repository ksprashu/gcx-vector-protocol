# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

description = "ðŸ”¨ WORK: Execution Phase. Implement and verify atomic changes."

prompt = """
You are entering the **EXECUTION (Act)** phase.

**User Instruction:** "{{args}}"

**Goal:** Execute the approved plan atomically, with immediate verification.

**Interaction Standards:**
1.  **Acknowledge:** State the specific task from the plan you are tackling.
2.  **Transparency:** Explain *what* you are changing before calling tools.
    *   State your understanding of the current task.
    *   Explain the intended action.
3.  **Closure:** Summarize the result.
4.  **Evidence Discipline:** Use official references for each major implementation decision.

**Scope:**
*   **ALLOWED:** implementing code, running tests, updating STATE.md.
*   **FORBIDDEN:** creating new broad plans (use /vector:plan) or open-ended exploration (use /vector:scan).

**Protocol:**
1.  **Context Loading (The 4-File Check):**
    *   **Read ALL** existing protocol files: `.gemini/CONTEXT.md`, `.gemini/PLAN.md`, `.gemini/STATE.md`, and `.gemini/BACKLOG.md` (if it exists).
    *   **CRITICAL:** NEVER use `run_shell_command` to execute `/vector:*` commands. These are for the USER to type.
2.  **Task Retrieval:**
    *   Identify the next pending task from `.gemini/PLAN.md`.
    *   If "{{args}}" is provided, prioritize that instruction within the context of the plan.
    *   Update `**Phase:**` in `.gemini/STATE.md` to `[EXECUTION]`.
3.  **External Evidence Pass (Mandatory):**
    *   Before implementation, gather authoritative official references for each major change decision.
    *   Build an Evidence Table with columns: **Topic | Source | Why authoritative | Last-checked**.
    *   Re-validate factual implementation details immediately before coding.
    *   If evidence is stale, conflicting, or incomplete, **HALT** and request user direction.
4.  **Execution Loop (Atomic Step):**
    *   **Implement:** Use `replace` or `write_file` to make the code change.
        *   *Constraint:* Adhere strictly to `.gemini/CONTEXT.md` (Standards).
    *   **Verify Facts Again (Mandatory):** Re-validate factual implementation details immediately before final verification.
    *   **Verify:** IMMEDIATELY run the build or test command (`run_shell_command`).
        *   *Constraint:* Do not proceed if verification fails.
    *   **Record:** Update `.gemini/STATE.md` with the result (Success/Failure) and output log.
        *   **Constraint:** **APPEND** to the `## 3. Scratchpad`. **DO NOT** overwrite previous entries.
    *   **Plan Progress:** Update the completed step in `.gemini/PLAN.md` from `- [ ]` to `- [x]`.
5.  **Error Handling:**
    *   If verification fails, **STOP**.
    *   Log the error in `.gemini/STATE.md`.
    *   Mark the failed step in `.gemini/PLAN.md` as `- [!]` with a brief failure reason.
    *   Propose a fix or request a strategy review (`/vector:scan`).

**Output:**
*   **Execution Summary:** What was done, what was verified.
*   **Evidence Table:** Include columns **Topic | Source | Why authoritative | Last-checked**.
*   **State:** Updated status in `.gemini/STATE.md`.
*   **Navigation:**
    *   **IF** Plan has more steps: `> Recommended Action: /vector:work <next_step>`
    *   **IF** Plan is complete: `> Recommended Action: /vector:save <commit_message>`
*   **Stopping Criteria:** If evidence is stale/conflicting/incomplete, **HALT** and request user direction. Otherwise, **STOP** after the atomic task. **WAIT** for the user to instruct the next step. **DO NOT** loop automatically. **DO NOT** execute the recommended command.
"""
